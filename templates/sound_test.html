<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Rating Questionnaire</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>
    <div class="container">
        <div class="questionnaire-box">
            <h1>Emotion Rating Questionnaire</h1>
            <p class="subtitle">Please complete the following questionnaire</p>
            
            <form id="questionnaireForm">
                <!-- Demographics Section -->
                <div class="section">
                    <h2>Demographics</h2>
                    
                    <div class="form-group">
                        <label for="age">Age *</label>
                        <input type="number" id="age" name="age" min="1" max="120" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" name="gender" required>
                            <option value="">-- Select --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Non-binary">Non-binary</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="highest_education">Highest Education *</label>
                        <select id="highest_education" name="highest_education" required>
                            <option value="">-- Select --</option>
                            <option value="Less than high school">Less than high school</option>
                            <option value="High school">High school</option>
                            <option value="Some college">Some college</option>
                            <option value="Bachelor's degree">Bachelor's degree</option>
                            <option value="Master's degree">Master's degree</option>
                            <option value="Doctoral degree">Doctoral degree</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Have you completed this questionnaire before? *</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="submitted_before" value="true" required>
                                Yes
                            </label>
                            <label>
                                <input type="radio" name="submitted_before" value="false">
                                No
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Sound Selection Section -->
                <div class="section" id="soundSelectionSection">
                    <h2>Sound Rating</h2>
                    <p class="info-text">How many sounds would you like to rate?</p>
                    
                    <div class="form-group">
                        <label for="numSounds">Number of Sounds *</label>
                        <select id="numSounds" name="numSounds">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    
                    <button type="button" class="submit-btn" onclick="loadSounds()">Load Sounds</button>
                </div>
                
                <!-- Emotion Ratings Section (Initially Hidden) -->
                <div class="section" id="emotionRatingsSection" style="display: none;">
                    <h2>Emotion Ratings</h2>
                    <p class="info-text">Listen to each sound and rate the emotions you feel. You can select 1 or 2 emotions per sound.</p>
                    
                    <div id="emotionRatings">
                        <!-- Sound rating items will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Feedback Section (Initially Hidden) -->
                <div class="section" id="feedbackSection" style="display: none;">
                    <h2>Additional Feedback</h2>
                    
                    <div class="form-group">
                        <label for="feedback">Comments (Optional)</label>
                        <textarea id="feedback" name="feedback" rows="4" placeholder="Any additional thoughts or feedback..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn" style="display: none;">Submit Questionnaire</button>
            </form>
            
            <div id="message" class="message"></div>
        </div>
    </div>
    
    <script>
        let soundFiles = [];
        let ratingCount = 0;
        
        async function loadSounds() {
            const numSounds = document.getElementById('numSounds').value;
            
            try {
                // Fetch sound files from backend
                const response = await fetch(`/get-sounds?count=${numSounds}`);
                const data = await response.json();
                
                if (!data.success) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = data.message || 'Error loading sounds.';
                    return;
                }
                
                soundFiles = data.sounds;
                
                if (soundFiles.length === 0) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'No sound files available.';
                    return;
                }
                
                // Hide sound selection section
                document.getElementById('soundSelectionSection').style.display = 'none';
                
                // Show emotion ratings section
                document.getElementById('emotionRatingsSection').style.display = 'block';
                document.getElementById('feedbackSection').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'block';
                
                // Clear any existing ratings
                document.getElementById('emotionRatings').innerHTML = '';
                ratingCount = 0;
                
                // Create rating items for each sound
                soundFiles.forEach((soundPath, index) => {
                    createRatingItem(index, soundPath);
                });
                
                // Setup validation listeners
                setupValidationListeners();
                
                // Clear any previous messages
                messageDiv.style.display = 'none';
                
            } catch (error) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Error loading sounds: ' + error.message;
            }
        }
        
        function createRatingItem(index, soundPath) {
            const container = document.getElementById('emotionRatings');
            const newRating = document.createElement('div');
            newRating.className = 'emotion-rating-item';
            newRating.dataset.index = index;
            
            // Extract filename for display
            const filename = soundPath.split(/[/\\]/).pop().replace(/\.wav$/i, '');
            
            newRating.innerHTML = `
                <h3>Sound #${index + 1} - ${filename}</h3>
                
                <!-- Audio Player -->
                <div class="audio-player">
                    <audio id="audio_${index}" controls preload="metadata">
                        <source src="${soundPath}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                </div>
                
                <div class="form-group">
                    <label for="emotion1_${index}">Primary Emotion *</label>
                    <select id="emotion1_${index}" name="emotion1_${index}" class="emotion-select" data-index="${index}" data-type="primary" required>
                        <option value="">-- Select --</option>
                        <option value="Happiness">Happiness</option>
                        <option value="Sadness">Sadness</option>
                        <option value="Anger">Anger</option>
                        <option value="Fear">Fear</option>
                        <option value="Surprise">Surprise</option>
                        <option value="Disgust">Disgust</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rating1_${index}">Primary Rating (1-5) *</label>
                    <input type="number" id="rating1_${index}" name="rating1_${index}" class="rating-input" data-index="${index}" data-type="primary" min="1" max="5" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="emotion2_${index}">Secondary Emotion (Optional)</label>
                    <select id="emotion2_${index}" name="emotion2_${index}" class="emotion-select" data-index="${index}" data-type="secondary">
                        <option value="">-- Select --</option>
                        <option value="Happiness">Happiness</option>
                        <option value="Sadness">Sadness</option>
                        <option value="Anger">Anger</option>
                        <option value="Fear">Fear</option>
                        <option value="Surprise">Surprise</option>
                        <option value="Disgust">Disgust</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rating2_${index}">Secondary Rating (1-5)</label>
                    <input type="number" id="rating2_${index}" name="rating2_${index}" class="rating-input" data-index="${index}" data-type="secondary" min="1" max="5" step="1">
                </div>
            `;
            
            container.appendChild(newRating);
            ratingCount = index + 1;
        }
        
        function setupValidationListeners() {
            // For all emotion selects and rating inputs
            document.querySelectorAll('.emotion-select').forEach(select => {
                select.addEventListener('change', function() {
                    validateEmotionRating(this);
                });
            });
            
            document.querySelectorAll('.rating-input').forEach(input => {
                input.addEventListener('input', function() {
                    validateEmotionRating(this);
                });
            });
        }
        
        function validateEmotionRating(element) {
            const index = element.dataset.index;
            const type = element.dataset.type;
            
            const emotionSelect = document.getElementById(`emotion${type === 'primary' ? '1' : '2'}_${index}`);
            const ratingInput = document.getElementById(`rating${type === 'primary' ? '1' : '2'}_${index}`);
            
            // If emotion is selected, make rating required
            if (emotionSelect.value) {
                ratingInput.required = true;
            } else {
                // If it's secondary, make it optional
                if (type === 'secondary') {
                    ratingInput.required = false;
                    ratingInput.value = ''; // Clear the value
                }
            }
            
            // If rating is entered, make emotion required (for secondary only)
            if (type === 'secondary' && ratingInput.value) {
                emotionSelect.required = true;
            } else if (type === 'secondary' && !ratingInput.value) {
                emotionSelect.required = false;
            }
        }
        
        document.getElementById('questionnaireForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const messageDiv = document.getElementById('message');
            
            // Collect all emotion ratings with validation
            const results = [];
            const ratingItems = document.querySelectorAll('.emotion-rating-item');
            let validationError = false;
            
            ratingItems.forEach(item => {
                const index = item.dataset.index;
                const emotion1 = formData.get(`emotion1_${index}`);
                const rating1 = formData.get(`rating1_${index}`);
                const emotion2 = formData.get(`emotion2_${index}`);
                const rating2 = formData.get(`rating2_${index}`);
                
                // Validate primary emotion and rating
                if (emotion1 && !rating1) {
                    validationError = true;
                    messageDiv.className = 'message error';
                    messageDiv.textContent = `Error: Please provide a rating for the primary emotion in Sound #${parseInt(index) + 1}`;
                    return;
                }
                
                // Validate secondary emotion and rating
                if (emotion2 && !rating2) {
                    validationError = true;
                    messageDiv.className = 'message error';
                    messageDiv.textContent = `Error: Please provide a rating for the secondary emotion in Sound #${parseInt(index) + 1}`;
                    return;
                }
                
                if (rating2 && !emotion2) {
                    validationError = true;
                    messageDiv.className = 'message error';
                    messageDiv.textContent = `Error: Please select a secondary emotion for Sound #${parseInt(index) + 1}`;
                    return;
                }
                
                if (emotion1 && rating1) {
                    // Get the sound file path for this rating
                    const soundPath = soundFiles[index];
                    const sound_code = soundPath.split(/[/\\]/).pop().replace(/\.wav$/i, '');
                    
                    results.push({
                        sound_code: sound_code,
                        emotion1: emotion1,
                        rating1: rating1,
                        emotion2: emotion2 || null,
                        rating2: rating2 || null
                    });
                }
            });
            
            // Stop if validation failed
            if (validationError) {
                return;
            }
            
            // Prepare submission data
            const data = {
                age: formData.get('age'),
                gender: formData.get('gender'),
                highest_education: formData.get('highest_education'),
                submitted_before: formData.get('submitted_before') === 'true',
                feedback: formData.get('feedback'),
                results: results
            };
            
            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageDiv.className = 'message success';
                    messageDiv.innerHTML = `
                        ${result.message}<br>
                        <strong>Your submission code: ${result.code}</strong><br>
                        <small>Please save this code for your records.</small>
                    `;
                    this.reset();
                    
                    // Reset the form to initial state
                    document.getElementById('soundSelectionSection').style.display = 'block';
                    document.getElementById('emotionRatingsSection').style.display = 'none';
                    document.getElementById('feedbackSection').style.display = 'none';
                    document.getElementById('submitBtn').style.display = 'none';
                    document.getElementById('emotionRatings').innerHTML = '';
                    soundFiles = [];
                    ratingCount = 0;
                } else {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Error: ' + result.message;
                }
            } catch (error) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'An error occurred. Please try again.';
            }
        });
    </script>
</body>
</html>